# building:
# sudo docker build -t haskell-build-ghcjs-runner-arch -f Dockerfile_arch .
# running:
# sudo docker run -d --name gitlab-runner --restart always -u root -v /srv/gitlab-runner/config:/etc/gitlab-runner haskell-build-ghcjs-runner-arch

# post install: add -fno-warn-tabs to .stack/programs/*/ghcjs-*/bin/ghcjs

FROM base/archlinux

RUN pacman -Sy --noconfirm archlinux-keyring
RUN pacman -Su --noconfirm
RUN pacman-db-upgrade
RUN pacman -S --noconfirm autoconf gcc make alex happy git binutils pkg-config ghc stack sdl2 openal ffmpeg nasm automake nodejs npm sudo fakeroot patch

# install gitlab-ci-multi-runner
RUN curl -Lo /usr/bin/gitlab-ci-multi-runner https://gitlab-ci-multi-runner-downloads.s3.amazonaws.com/latest/binaries/gitlab-ci-multi-runner-linux-amd64 \
	&& chmod +x /usr/bin/gitlab-ci-multi-runner \
	&& useradd -m -s /bin/bash gitlab-runner

# ncurses5-compat-libs
# using own copy of PKGBUILD as one on AUR is broken
COPY ncurses5-compat-libs ncurses5-compat-libs
RUN chmod a+rw ncurses5-compat-libs \
	&& cd ncurses5-compat-libs \
	&& sudo -u nobody makepkg -c \
	&& pacman -U --noconfirm ncurses5-compat-libs-*.pkg.tar.xz \
	&& cd .. \
	&& rm -rf ncurses5-compat-libs

# libtinfo from AUR
RUN git clone https://aur.archlinux.org/libtinfo.git libtinfo \
	&& chmod a+rw libtinfo \
	&& cd libtinfo \
	&& sudo -u nobody makepkg -c \
	&& pacman -U --noconfirm libtinfo-*.pkg.tar.xz \
	&& cd .. \
	&& rm -rf libtinfo

# uglify-js
RUN npm install -g uglify-js
# minifyjs script
RUN /bin/echo -e '#!/bin/sh\nuglifyjs $1 --screw-ie8 --mangle --compress --wrap $1 --output $2' > /bin/minifyjs && chmod +x /bin/minifyjs

# add local bin to profile
RUN /bin/echo -e '#!/bin/sh\nexport PATH=$PATH:$HOME/.local/bin' > /etc/profile.d/localbin.sh

# following installations doesn't require root
USER gitlab-runner
WORKDIR /home/gitlab-runner

# add config.yaml
RUN mkdir .stack && /bin/echo -e 'build:\n  split-objs: true\n' > .stack/config.yaml

# install ghcjs
COPY ghcjs-setup.yaml ghcjs-setup.yaml
RUN stack setup --stack-yaml ghcjs-setup.yaml

# patch ghcjs script to add some options
COPY ghcjs.patch ghcjs.patch
RUN patch .stack/programs/x86_64-linux/ghcjs-0.2.0_ghc-7.10.3/bin/ghcjs < ghcjs.patch

# install hscolour for haddocks, and hlint
RUN stack install hscolour hlint

# install butler
RUN curl -Lo /home/gitlab-runner/.local/bin/butler https://dl.itch.ovh/butler/linux-amd64/head/butler \
	&& chmod +x /home/gitlab-runner/.local/bin/butler
# copy butler credentials
COPY butler_creds /home/gitlab-runner/.config/itch/butler_creds

# finalize
CMD ["gitlab-ci-multi-runner", "run", "--user=gitlab-runner", "--working-directory=/home/gitlab-runner"]
VOLUME ["/etc/gitlab-runner"]
